---
/**
 * PhoneSelector Component
 *
 * Shows a verified phone number with options to proceed or change.
 * Used when a user already has a valid verification token.
 *
 * Dispatches custom events:
 * - 'phone-selected': When user chooses to proceed with verified number, includes { phone } in detail
 * - 'change-phone': When user wants to use a different phone number
 *
 * Usage:
 * <PhoneSelector id="my-selector" phone="+962782760965" />
 *
 * Listen for events:
 * document.getElementById('my-selector').addEventListener('phone-selected', (e) => {
 *   const { phone } = e.detail;
 * });
 * document.getElementById('my-selector').addEventListener('change-phone', () => {
 *   // Show verification form
 * });
 */

interface Props {
  id?: string;
  class?: string;
  phone?: string;
}

const { id = 'phone-selector', class: className = '', phone = '' } = Astro.props;

// Country codes (1-3 digits)
const countryCodes = [
  '1', '7', '20', '27', '30', '31', '32', '33', '34', '36', '39', '40', '41', '43', '44', '45', '46', '47', '48', '49',
  '51', '52', '53', '54', '55', '56', '57', '58', '60', '61', '62', '63', '64', '65', '66', '81', '82', '84', '86', '90', '91', '92', '93', '94', '95', '98',
  '211', '212', '213', '216', '218', '220', '221', '222', '223', '224', '225', '226', '227', '228', '229', '230', '231', '232', '233', '234', '235', '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '250', '251', '252', '253', '254', '255', '256', '257', '258', '260', '261', '262', '263', '264', '265', '266', '267', '268', '269',
  '290', '291', '297', '298', '299', '350', '351', '352', '353', '354', '355', '356', '357', '358', '359', '370', '371', '372', '373', '374', '375', '376', '377', '378', '380', '381', '382', '383', '385', '386', '387', '389',
  '420', '421', '423', '500', '501', '502', '503', '504', '505', '506', '507', '508', '509', '590', '591', '592', '593', '594', '595', '596', '597', '598', '599',
  '670', '672', '673', '674', '675', '676', '677', '678', '679', '680', '681', '682', '683', '685', '686', '687', '688', '689', '690', '691', '692',
  '850', '852', '853', '855', '856', '880', '886', '960', '961', '962', '963', '964', '965', '966', '967', '968', '970', '971', '972', '973', '974', '975', '976', '977', '992', '993', '994', '995', '996', '998'
];

// Format phone for display
function formatPhoneDisplay(phone: string): string {
  const digits = phone.replace(/^\+/, '');

  // Find matching country code (check 3-digit, then 2-digit, then 1-digit)
  let countryCode = '';
  for (let len = 3; len >= 1; len--) {
    const prefix = digits.slice(0, len);
    if (countryCodes.includes(prefix)) {
      countryCode = prefix;
      break;
    }
  }

  if (!countryCode) {
    return phone.startsWith('+') ? phone : '+' + phone;
  }

  const rest = digits.slice(countryCode.length);
  // Group remaining digits in chunks of 3
  const groups = rest.match(/.{1,3}/g) || [];
  return '+' + countryCode + ' ' + groups.join(' ');
}

const displayPhone = formatPhoneDisplay(phone);
---

<div id={id} class={`phone-selector ${className}`} data-phone={phone}>
  <div class="text-center">
    <p class="text-gray-600 dark:text-gray-400 mb-2">
      رقم الهاتف المحفوظ
    </p>

    <p class="phone-number text-2xl text-gray-900 dark:text-white mb-6" dir="ltr">
      {displayPhone}
    </p>

    <!-- Proceed Button -->
    <button
      type="button"
      class="proceed-btn w-full btn-primary py-3 mb-3 flex items-center justify-center gap-2"
    >
      <span>المتابعة بهذا الرقم</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" transform="scale(-1, 1)">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
      </svg>
    </button>

    <!-- Change Number Link -->
    <button
      type="button"
      class="change-phone-btn text-sm text-primary hover:text-secondary underline underline-offset-4"
    >
      ليس رقمك؟ اضغط هنا لتغيير الرقم المحفوظ
    </button>
  </div>
</div>

<script>
  function initPhoneSelector() {
    document.querySelectorAll('.phone-selector').forEach((container) => {
      // Skip if already initialized
      if (container.dataset.initialized === 'true') return;
      container.dataset.initialized = 'true';

      const proceedBtn = container.querySelector('.proceed-btn') as HTMLButtonElement;
      const changePhoneBtn = container.querySelector('.change-phone-btn') as HTMLButtonElement;

      // Proceed with verified number - read phone fresh at click time
      proceedBtn.addEventListener('click', () => {
        const phone = container.dataset.phone;  // Read fresh, not captured at init
        container.dispatchEvent(new CustomEvent('phone-selected', {
          bubbles: true,
          detail: { phone }
        }));
      });

      // Request to change number
      changePhoneBtn.addEventListener('click', () => {
        container.dispatchEvent(new CustomEvent('change-phone', {
          bubbles: true
        }));
      });
    });
  }

  // Initialize on page load and after View Transitions
  // Use DOMContentLoaded as fallback for pages without Astro router (like popups)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhoneSelector);
  } else {
    initPhoneSelector();
  }
  document.addEventListener('astro:page-load', initPhoneSelector);
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@600&display=swap');

  .phone-number {
    font-family: 'Source Code Pro', monospace !important;
    letter-spacing: 0.05em;
  }
</style>
