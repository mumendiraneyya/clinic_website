---
import { Icon } from 'astro-icon/components';
import Logo from '~/components/Logo.astro';
import ToggleTheme from '~/components/common/ToggleTheme.astro';
import ToggleMenu from '~/components/common/ToggleMenu.astro';

import { getHomePermalink } from '~/utils/permalinks';
import { trimSlash } from '~/utils/permalinks';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
  description?: string;
  hidden?: boolean;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  socialLinks?: Array<Link>;
  isSticky?: boolean;
  isDark?: boolean;
  showToggleTheme?: boolean;
}

const {
  id = 'header',
  links = [],
  socialLinks = [],
  isSticky = false,
  isDark = false,
  showToggleTheme = false,
} = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;

// Filter out hidden menu items
const enabledLinks = links.filter((link) => !link.hidden).map((link) => ({
  ...link,
  links: link.links?.filter((subLink) => !subLink.hidden),
}));
---

<header
  class:list={[
    { sticky: isSticky, relative: !isSticky, dark: isDark },
    'top-0 z-40 flex-none mx-auto w-full border-b border-gray-50/0 transition-[opacity] ease-in-out',
  ]}
  {...isSticky ? { 'data-aw-sticky-header': true } : {}}
  {...id ? { id } : {}}
>
  <div class="header-container relative text-default py-3 px-4 md:px-6 mx-auto w-full max-w-7xl">
    <!-- Mobile: Logo right, Hamburger left -->
    <div class="mobile-header flex justify-between items-center md:hidden">
      <ToggleMenu />
      <a class="flex items-center" href={getHomePermalink()}>
        <Logo />
      </a>
    </div>

    <!-- Desktop: Theme toggle left, Nav center, Logo right -->
    <div class="desktop-header hidden md:flex items-center justify-between">
      <!-- Left: Theme toggle -->
      <div class="flex-shrink-0">
        {showToggleTheme && <ToggleTheme iconClass="w-5 h-5" />}
      </div>

      <!-- Center: Navigation -->
      <nav class="nav-desktop flex-1 flex justify-center mx-4" aria-label="Main navigation">
        <ul class="flex items-center gap-1">
          {
            enabledLinks.map(({ text, href, links: subLinks }) => (
              <li class={subLinks?.length ? 'dropdown relative' : ''}>
                {subLinks?.length ? (
                  <>
                    <a
                      class="nav-link hover:text-link dark:hover:text-white px-3 py-2 flex items-center whitespace-nowrap"
                      href={href}
                    >
                      {text}
                      <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ms-1" />
                    </a>
                    <ul class="dropdown-menu hidden backdrop-blur-md dark:bg-dark rounded absolute font-medium bg-white/90 min-w-[200px] drop-shadow-xl">
                      {subLinks.map(({ text: text2, href: href2, description: desc2, links: nestedLinks }) => (
                        <li class={nestedLinks?.length ? 'nested-dropdown relative' : ''}>
                          {nestedLinks?.length ? (
                            <>
                              <a
                                class:list={[
                                  'first:rounded-t last:rounded-b hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 flex items-center justify-between whitespace-nowrap nav-link',
                                  { 'aw-link-active': href2 === currentPath },
                                ]}
                                href={href2}
                              >
                                {text2}
                                <Icon name="tabler:chevron-left" class="w-3.5 h-3.5 ms-2" />
                              </a>
                              <ul class="nested-menu hidden backdrop-blur-md dark:bg-dark rounded absolute font-medium bg-white/90 min-w-[200px] drop-shadow-xl">
                                {nestedLinks.map(({ text: text3, href: href3 }) => (
                                  <li>
                                    <a
                                      class:list={[
                                        'first:rounded-t last:rounded-b hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-nowrap nav-link',
                                        { 'aw-link-active': href3 === currentPath },
                                      ]}
                                      href={href3}
                                    >
                                      {text3}
                                    </a>
                                  </li>
                                ))}
                              </ul>
                            </>
                          ) : (
                            <a
                              class:list={[
                                'first:rounded-t last:rounded-b hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-nowrap nav-link',
                                { 'aw-link-active': href2 === currentPath },
                              ]}
                              href={href2}
                            >
                              {text2}{desc2 && <span class="font-normal text-muted"> ({desc2})</span>}
                            </a>
                          )}
                        </li>
                      ))}
                    </ul>
                  </>
                ) : (
                  <a
                    class:list={[
                      'nav-link hover:text-link dark:hover:text-white px-3 py-2 flex items-center whitespace-nowrap',
                      { 'aw-link-active': href === currentPath },
                    ]}
                    href={href}
                  >
                    {text}
                    <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ms-1 invisible" />
                  </a>
                )}
              </li>
            ))
          }
        </ul>
      </nav>

      <!-- Right: Logo -->
      <div class="flex-shrink-0">
        <a class="flex items-center" href={getHomePermalink()}>
          <Logo />
        </a>
      </div>
    </div>

    <!-- Mobile Navigation (shown when menu is expanded) -->
    <nav
      class="nav-mobile items-center w-full hidden text-default overflow-y-auto overflow-x-hidden md:!hidden"
      aria-label="Mobile navigation"
    >
      <ul class="flex flex-col w-full text-xl tracking-[0.01rem] font-medium pt-4">
        {
          enabledLinks.map(({ text, href, links: subLinks }) => (
            <li class={subLinks?.length ? 'dropdown' : ''}>
              {subLinks?.length ? (
                <>
                  <a
                    class="hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap"
                    href={href}
                  >
                    {text}
                  </a>
                  <ul class="dropdown-menu">
                    {subLinks.map(({ text: text2, href: href2, description: desc2, links: nestedLinks }) => (
                      <li class={nestedLinks?.length ? 'mobile-nested-dropdown' : ''}>
                        <a
                          class:list={[
                            'hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 flex items-center whitespace-nowrap text-base ps-8',
                            { 'aw-link-active': href2 === currentPath },
                          ]}
                          href={href2}
                        >
                          {text2}{desc2 && <span class="font-normal text-muted"> ({desc2})</span>}
                          {nestedLinks?.length && <Icon name="tabler:chevron-down" class="w-4 h-4 ms-2 mobile-nested-chevron transition-transform" />}
                        </a>
                        {nestedLinks?.length && (
                          <ul class="mobile-nested-menu hidden">
                            {nestedLinks.map(({ text: text3, href: href3 }) => (
                              <li>
                                <a
                                  class:list={[
                                    'hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-nowrap text-sm ps-12',
                                    { 'aw-link-active': href3 === currentPath },
                                  ]}
                                  href={href3}
                                >
                                  {text3}
                                </a>
                              </li>
                            ))}
                          </ul>
                        )}
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <a
                  class:list={[
                    'hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap',
                    { 'aw-link-active': href === currentPath },
                  ]}
                  href={href}
                >
                  {text}
                </a>
              )}
            </li>
          ))
        }
        <!-- Mobile-only call link -->
        <li>
          <a
            class="hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap"
            href="tel:+962799133299"
          >
            اتصل بنا هاتفيًا
            <Icon name="tabler:phone" class="w-5 h-5 ms-2" />
          </a>
        </li>
        <!-- Mobile theme toggle -->
        {showToggleTheme && (
          <li class="px-4 py-3">
            <ToggleTheme iconClass="w-6 h-6" showLabel />
          </li>
        )}
        <!-- Mobile-only social links -->
        {socialLinks?.length > 0 && (
          <li class="px-4 py-3 mt-2 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-center gap-3 flex-wrap">
              {socialLinks.map(({ ariaLabel, href, icon }) => (
                <a
                  class="text-muted dark:text-gray-400 hover:text-link dark:hover:text-white p-2 inline-flex items-center"
                  aria-label={ariaLabel}
                  href={href}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {icon && <Icon name={icon} class="w-6 h-6" />}
                </a>
              ))}
            </div>
          </li>
        )}
      </ul>
    </nav>
  </div>
</header>

<style>
  /* Responsive nav font size: scales from 1rem at 768px to 1.25rem at 1024px+ */
  .nav-link {
    font-size: clamp(1rem, calc(0.25rem + 1.56vw), 1.25rem);
    font-weight: 500;
  }
</style>
