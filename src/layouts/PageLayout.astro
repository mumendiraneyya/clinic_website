---
import Layout from '~/layouts/Layout.astro';
import Header from '~/components/widgets/Header.astro';
import Footer from '~/components/widgets/Footer.astro';
import Announcement from '~/components/widgets/Announcement.astro';

import { headerData, footerData, blogCategoryOrder } from '~/navigation';
import { fetchPosts } from '~/utils/blog';
import { getBlogPermalink, getPermalink } from '~/utils/permalinks';
import type { MetaData } from '~/types';

export interface Props {
  metadata?: MetaData;
}

const { metadata } = Astro.props;

import { UI } from 'astrowind:config';
const showAnnouncement = UI?.showAnnouncement ?? true;

// Build dynamic header with blog categories
const posts = await fetchPosts();

// Group posts by category
const postsByCategory: Record<string, { title: string; slug: string; posts: typeof posts }> = {};
posts.forEach((post) => {
  if (post.category?.slug) {
    if (!postsByCategory[post.category.slug]) {
      postsByCategory[post.category.slug] = {
        title: post.category.title,
        slug: post.category.slug,
        posts: [],
      };
    }
    postsByCategory[post.category.slug].posts.push(post);
  }
});

// Build category links with nested post links in specified order
const blogLinks = [
  { text: 'جميع المنشورات', href: getBlogPermalink() },
  ...blogCategoryOrder
    .map((categoryTitle) => {
      const categoryData = Object.values(postsByCategory).find((c) => c.title === categoryTitle);
      if (!categoryData) return null;
      return {
        text: categoryData.title,
        href: getPermalink(categoryData.slug, 'category'),
        links: categoryData.posts.map((post) => ({
          text: post.title,
          href: `/${post.permalink}`,
        })),
      };
    })
    .filter((link): link is NonNullable<typeof link> => link !== null),
];

const dynamicHeaderData = {
  ...headerData,
  links: headerData.links.map((link) =>
    link.text === 'المنشورات' ? { ...link, links: blogLinks } : link
  ),
};
---

<Layout metadata={metadata}>
  { showAnnouncement &&
    <slot name="announcement">
      <Announcement />
    </slot> 
  }
  <slot name="header">
    <Header {...dynamicHeaderData} socialLinks={footerData.socialLinks} isSticky showToggleTheme />
  </slot>
  <main>
    <slot />
  </main>
  <slot name="footer">
    <Footer {...footerData} />
  </slot>
</Layout>
