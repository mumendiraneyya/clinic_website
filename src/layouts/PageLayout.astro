---
import Layout from '~/layouts/Layout.astro';
import Header from '~/components/widgets/Header.astro';
import Footer from '~/components/widgets/Footer.astro';
import Announcement from '~/components/widgets/Announcement.astro';

import { headerData, footerData } from '~/navigation';
import { fetchPosts } from '~/utils/blog';
import { getBlogPermalink } from '~/utils/permalinks';

import type { MetaData } from '~/types';

export interface Props {
  metadata?: MetaData;
}

const { metadata } = Astro.props;

import { UI } from 'astrowind:config';
const showAnnouncement = UI?.showAnnouncement ?? true;

// Build dynamic header with blog posts
const posts = await fetchPosts();
const blogLinks = [
  { text: 'جميع المقالات', href: getBlogPermalink() },
  ...posts.slice(0, 5).map((post) => ({
    text: post.title,
    href: `/${post.permalink}`,
  })),
];

const dynamicHeaderData = {
  ...headerData,
  links: headerData.links.map((link) =>
    link.text === 'المنشورات' ? { ...link, links: blogLinks } : link
  ),
};
---

<Layout metadata={metadata}>
  { showAnnouncement &&
    <slot name="announcement">
      <Announcement />
    </slot> 
  }
  <slot name="header">
    <Header {...dynamicHeaderData} socialLinks={footerData.socialLinks} isSticky showToggleTheme />
  </slot>
  <main>
    <slot />
  </main>
  <slot name="footer">
    <Footer {...footerData} />
  </slot>
</Layout>
