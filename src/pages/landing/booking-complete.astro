---
import Layout from '~/layouts/PageLayout.astro';
import Location from '~/components/widgets/Location.astro';
import BookingCard from '~/components/booking/BookingCard.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­',
  robots: {
    index: false,
    follow: false,
  },
};
---

<Layout metadata={metadata}>
  <section class="py-12 md:py-20">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 text-center">
      <div id="status-icon" class="mb-8">
        <span class="text-6xl">â³</span>
      </div>

      <h1 id="status-title" class="text-4xl md:text-5xl font-bold mb-4 font-heading dark:text-gray-200">
        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¬Ø§Ø±Ù...
      </h1>

      <p id="status-message" class="text-xl text-muted dark:text-slate-300 mb-8">
        ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø­Ø¬Ø²Ùƒ.
      </p>

      <!-- Booking Details Card (hidden until confirmed) -->
      <div id="booking-card-container" class="hidden mb-8">
        <BookingCard id="confirmation-booking-card" />
      </div>

      <!-- Home button - always visible -->
      <div class="mb-6 text-center">
        <a
          href="/"
          class="btn-primary inline-flex items-center gap-2"
        >
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>
      </div>

      <!-- Bookings page button - shown after confirmation -->
      <div id="bookings-link-container" class="hidden mb-6 text-center">
        <a href="/bookings" class="btn-secondary inline-flex items-center gap-2">
          <Icon name="tabler:calendar-event" class="w-5 h-5" />
          <span>Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</span>
        </a>
      </div>

    </div>
  </section>

  <!-- Location Widget - shown only for clinic appointments -->
  <div id="location-section" class="hidden">
    <Location
      title="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©"
      address="Ù¡Ù£ Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø¬Ø¨ÙŠØ±<br>Ø¹Ù…Ù‘Ø§Ù†ØŒ Ø§Ù„Ø£Ø±Ø¯Ù†<br>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: Ù¡Ù¡Ù¡Ù©Ù¡"
      phones={[
        { label: 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©', number: '+962 79 887 2899' },
        { label: 'Ø§Ù„Ø·Ø¨ÙŠØ¨', number: '+962 79 913 3299' },
      ]}
      directions="Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ù…Ø¬Ù…Ø¹ Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù†ÙˆØ± Ø§Ù„ØªØ®ØµØµÙŠØ© (Ø¨Ø¬ÙˆØ§Ø± Ø·ÙˆØ§Ø±Ø¦ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ø¨Ù† Ø§Ù„Ù‡ÙŠØ«Ù…)"
      mapEmbedUrl="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3383.6483017800597!2d35.87309270000001!3d31.9975482!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x151ca187ec5aa2d7%3A0xc23a1a2298e1af8b!2z2LnZitin2K_YqSDYry4g2YXYpNmF2YYg2YXYo9mF2YjZhiDYr9mK2LHYp9mG2YrYqQ!5e0!3m2!1sen!2sjo!4v1765579024750!5m2!1sen!2sjo"
      mapLink="https://maps.app.goo.gl/RE3yv34U16Ssdezj7"
    >
      <Fragment slot="bg">
        <div class="absolute inset-0 bg-tertiary/20 dark:bg-transparent"></div>
      </Fragment>
    </Location>
  </div>

  <script is:inline>
    /* eslint-disable no-var */
    // Cal.com API configuration
    var CAL_API_BASE = 'https://api.cal.com/v2';
    var CAL_API_VERSION = '2024-08-13';
    var POLL_INTERVAL_MS = 3000; // Poll every 3 seconds
    var MAX_POLL_ATTEMPTS = 40; // Max ~2 minutes of polling

    // Status configurations
    var STATUS_CONFIG = {
      pending: {
        icon: 'â³',
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¬Ø§Ø±Ù...',
        message: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø­Ø¬Ø²Ùƒ.'
      },
      accepted: {
        icon: 'âœ…',
        title: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­',
        message: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯Ùƒ ÙˆØ³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ.'
      },
      rejected: {
        icon: 'âŒ',
        title: 'Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø²',
        message: 'Ù„Ù„Ø£Ø³ÙØŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø¬Ø². ØªØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„Ù Ù…Ø¹Ù†Ø§.'
      },
      cancelled: {
        icon: 'ğŸš«',
        title: 'Ø§Ù„Ø­Ø¬Ø² Ù…Ù„ØºÙ‰',
        message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.'
      },
      error: {
        icon: 'âš ï¸',
        title: 'Ø­Ø¯Ø« Ø®Ø·Ø£',
        message: 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø². ØªØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.'
      }
    };
    // Update status UI elements
    function updateStatusUI(statusKey) {
      var config = STATUS_CONFIG[statusKey];
      if (!config) return;

      var iconEl = document.getElementById('status-icon');
      var titleEl = document.getElementById('status-title');
      var messageEl = document.getElementById('status-message');

      if (iconEl) iconEl.innerHTML = '<span class="text-6xl">' + config.icon + '</span>';
      if (titleEl) titleEl.textContent = config.title;
      if (messageEl) messageEl.textContent = config.message;
    }

    // Fetch booking status from Cal.com API
    function fetchBookingStatus(bookingUid) {
      return fetch(CAL_API_BASE + '/bookings/' + bookingUid, {
        method: 'GET',
        headers: {
          'cal-api-version': CAL_API_VERSION
        }
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('API request failed: ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        if (data.status === 'success' && data.data) {
          return data.data;
        }
        throw new Error('Invalid API response');
      });
    }

    // Poll for booking status until it changes from pending
    function pollBookingStatus(bookingUid, params, attempt) {
      if (attempt >= MAX_POLL_ATTEMPTS) {
        // Max attempts reached, show error
        updateStatusUI('error');
        return;
      }

      fetchBookingStatus(bookingUid)
        .then(function(booking) {
          var status = booking.status ? booking.status.toLowerCase() : 'pending';

          // Check for final statuses
          if (status === 'accepted') {
            updateStatusUI('accepted');
            showBookingDetails(params, booking);
          } else if (status === 'rejected') {
            updateStatusUI('rejected');
          } else if (status === 'cancelled') {
            updateStatusUI('cancelled');
          } else {
            // Still pending, poll again after interval
            setTimeout(function() {
              pollBookingStatus(bookingUid, params, attempt + 1);
            }, POLL_INTERVAL_MS);
          }
        })
        .catch(function(error) {
          console.error('Error fetching booking status:', error);
          // On error, retry a few times before giving up
          if (attempt < 3) {
            setTimeout(function() {
              pollBookingStatus(bookingUid, params, attempt + 1);
            }, POLL_INTERVAL_MS);
          } else {
            updateStatusUI('error');
          }
        });
    }

    // Show booking details after confirmation using BookingCard component
    function showBookingDetails(params, booking) {
      var cardContainer = document.getElementById('booking-card-container');
      var locationSection = document.getElementById('location-section');
      var isClinic = params.eventTypeSlug === 'clinic';

      // Show booking card container
      if (cardContainer) {
        cardContainer.classList.remove('hidden');
      }

      // Show location widget for clinic appointments
      if (isClinic && locationSection) {
        locationSection.classList.remove('hidden');
      }

      // Convert URL params + API response to booking object format expected by BookingCard
      var bookingData = {
        uid: params.uid,
        start: params.startTime,
        end: params.endTime,
        eventType: { slug: params.eventTypeSlug },
        meetingUrl: booking.meetingUrl,
        attendees: booking.attendees
      };

      // Initialize the BookingCard using the shared utility
      if (window.BookingCardUtils) {
        window.BookingCardUtils.initBookingCard('confirmation-booking-card', bookingData, {
          onLocationClick: function(isClinicAppointment, meetingUrl) {
            if (isClinicAppointment) {
              // Scroll to location section for clinic appointments
              var section = document.getElementById('location-section');
              if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
              }
            } else {
              // Open video link for remote appointments
              window.open(meetingUrl || ('https://app.cal.com/video/' + params.uid), '_blank', 'noopener,noreferrer');
            }
          }
        });
      }

      // Show bookings page navigation button
      var bookingsLink = document.getElementById('bookings-link-container');
      if (bookingsLink) {
        bookingsLink.classList.remove('hidden');
      }
    }

    function initBookingComplete() {
      var params = Object.fromEntries(new URLSearchParams(window.location.search));

      // Check if we have booking data
      if (!params.uid) {
        // No UID, cannot verify - show error
        updateStatusUI('error');
        return;
      }

      // Start polling for booking status
      pollBookingStatus(params.uid, params, 0);
    }

    // Initialize on page load
    document.addEventListener('astro:page-load', function() {
      if (window.location.pathname.includes('/landing/booking-complete')) {
        initBookingComplete();
      }
    });
  </script>
</Layout>
