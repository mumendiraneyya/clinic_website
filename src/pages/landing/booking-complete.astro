---
import Layout from '~/layouts/PageLayout.astro';
import Location from '~/components/widgets/Location.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­',
  robots: {
    index: false,
    follow: false,
  },
};
---

<Layout metadata={metadata}>
  <section class="py-12 md:py-20">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 text-center">
      <div id="status-icon" class="mb-8">
        <span class="text-6xl">â³</span>
      </div>

      <h1 id="status-title" class="text-4xl md:text-5xl font-bold mb-4 font-heading dark:text-gray-200">
        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¬Ø§Ø±Ù...
      </h1>

      <p id="status-message" class="text-xl text-muted dark:text-slate-300 mb-8">
        ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø­Ø¬Ø²Ùƒ.
      </p>

      <!-- Booking Details Card -->
      <div id="booking-details" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-start">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <Icon name="tabler:calendar-event" class="w-5 h-5 text-primary" />
          <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</span>
        </h2>

        <div class="space-y-3">
          <!-- Appointment Type -->
          <div class="flex items-center gap-3">
            <Icon name="tabler:stethoscope" class="w-5 h-5 text-muted" />
            <span id="booking-type" class="text-gray-700 dark:text-gray-300"></span>
          </div>

          <!-- Date -->
          <div class="flex items-center gap-3">
            <Icon name="tabler:calendar" class="w-5 h-5 text-muted" />
            <span id="booking-date" class="text-gray-700 dark:text-gray-300"></span>
          </div>

          <!-- Time -->
          <div class="flex items-center gap-3">
            <Icon name="tabler:clock" class="w-5 h-5 text-muted" />
            <span id="booking-time" class="text-gray-700 dark:text-gray-300"></span>
          </div>

          <!-- Location Link -->
          <div id="booking-link-row" class="hidden flex items-center gap-3">
            <Icon name="tabler:link" class="w-5 h-5 text-muted" />
            <button id="booking-link" type="button" class="text-primary hover:underline cursor-pointer bg-transparent border-none p-0 text-start"></button>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mb-6 flex flex-wrap items-center justify-center gap-4">
        <!-- Add to Calendar - only shown on success -->
        <div id="add-to-calendar-container" class="hidden relative">
          <button
            id="add-to-calendar-btn"
            type="button"
            class="btn-primary inline-flex items-center gap-2"
          >
            <Icon name="tabler:calendar-plus" class="w-5 h-5" />
            <span>Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</span>
            <Icon name="tabler:chevron-down" class="w-4 h-4" />
          </button>

          <!-- Dropdown Menu -->
          <div
            id="calendar-dropdown"
            class="hidden absolute z-10 mt-2 w-56 rounded-lg bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10"
            style="left: 50%; transform: translateX(-50%);"
          >
            <div class="py-1">
              <a
                id="google-calendar-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                <Icon name="tabler:brand-google" class="w-5 h-5 text-[#4285F4]" />
                <span>ØªÙ‚ÙˆÙŠÙ… ØºÙˆØºÙ„</span>
              </a>
              <a
                id="apple-calendar-link"
                href="#"
                download="appointment.ics"
                class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                <Icon name="tabler:brand-apple" class="w-5 h-5" />
                <span>ØªÙ‚ÙˆÙŠÙ… Ø£Ø¨Ù„</span>
              </a>
              <a
                id="outlook-calendar-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                <Icon name="tabler:brand-windows" class="w-5 h-5 text-[#0078D4]" />
                <span>ØªÙ‚ÙˆÙŠÙ… Ø£ÙˆØªÙ„Ùƒ</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Home button - always visible -->
        <a
          href="/"
          class="btn-primary inline-flex items-center gap-2"
        >
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>
      </div>

    </div>
  </section>

  <!-- Location Widget - shown only for clinic appointments -->
  <div id="location-section" class="hidden">
    <Location
      title="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©"
      address="Ù¡Ù£ Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø¬Ø¨ÙŠØ±<br>Ø¹Ù…Ù‘Ø§Ù†ØŒ Ø§Ù„Ø£Ø±Ø¯Ù†<br>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: Ù¡Ù¡Ù¡Ù©Ù¡"
      phones={[
        { label: 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©', number: '+962 79 887 2899' },
        { label: 'Ø§Ù„Ø·Ø¨ÙŠØ¨', number: '+962 79 913 3299' },
      ]}
      directions="Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ù…Ø¬Ù…Ø¹ Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù†ÙˆØ± Ø§Ù„ØªØ®ØµØµÙŠØ© (Ø¨Ø¬ÙˆØ§Ø± Ø·ÙˆØ§Ø±Ø¦ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ø¨Ù† Ø§Ù„Ù‡ÙŠØ«Ù…)"
      mapEmbedUrl="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3383.6483017800597!2d35.87309270000001!3d31.9975482!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x151ca187ec5aa2d7%3A0xc23a1a2298e1af8b!2z2LnZitin2K_YqSDYry4g2YXYpNmF2YYg2YXYo9mF2YjZhiDYr9mK2LHYp9mG2YrYqQ!5e0!3m2!1sen!2sjo!4v1765579024750!5m2!1sen!2sjo"
      mapLink="https://maps.app.goo.gl/RE3yv34U16Ssdezj7"
    >
      <Fragment slot="bg">
        <div class="absolute inset-0 bg-tertiary/20 dark:bg-transparent"></div>
      </Fragment>
    </Location>
  </div>

  <script is:inline>
    /* eslint-disable no-var */
    // Cal.com API configuration
    var CAL_API_BASE = 'https://api.cal.com/v2';
    var CAL_API_VERSION = '2024-08-13';
    var POLL_INTERVAL_MS = 3000; // Poll every 3 seconds
    var MAX_POLL_ATTEMPTS = 40; // Max ~2 minutes of polling

    // Status configurations
    var STATUS_CONFIG = {
      pending: {
        icon: 'â³',
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¬Ø§Ø±Ù...',
        message: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø­Ø¬Ø²Ùƒ.'
      },
      accepted: {
        icon: 'âœ…',
        title: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­',
        message: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯Ùƒ ÙˆØ³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ.'
      },
      rejected: {
        icon: 'âŒ',
        title: 'Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø²',
        message: 'Ù„Ù„Ø£Ø³ÙØŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø¬Ø². ØªØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„Ù Ù…Ø¹Ù†Ø§.'
      },
      cancelled: {
        icon: 'ğŸš«',
        title: 'Ø§Ù„Ø­Ø¬Ø² Ù…Ù„ØºÙ‰',
        message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.'
      },
      error: {
        icon: 'âš ï¸',
        title: 'Ø­Ø¯Ø« Ø®Ø·Ø£',
        message: 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø². ØªØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.'
      }
    };

    // Arabic day and month names
    var arabicDays = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    var arabicMonths = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];

    // Convert number to Arabic numerals
    function toArabicNumerals(num) {
      var arabicDigits = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      return String(num).split('').map(function(d) {
        return arabicDigits[parseInt(d)] || d;
      }).join('');
    }

    // Format date in Arabic
    function formatArabicDate(dateStr) {
      var date = new Date(dateStr);
      var day = arabicDays[date.getDay()];
      var dayNum = toArabicNumerals(date.getDate());
      var month = arabicMonths[date.getMonth()];
      var year = toArabicNumerals(date.getFullYear());
      return day + 'ØŒ ' + dayNum + ' ' + month + ' ' + year;
    }

    // Format time in Arabic (12-hour format)
    function formatArabicTime(dateStr) {
      var date = new Date(dateStr);
      var hours = date.getHours();
      var minutes = date.getMinutes();
      var period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
      hours = hours % 12 || 12;
      var minutesStr = minutes < 10 ? '0' + minutes : String(minutes);
      return toArabicNumerals(hours) + ':' + toArabicNumerals(minutesStr) + ' ' + period;
    }

    // Get Arabic timezone name from IANA timezone
    function getArabicTimezoneName(timeZone, locale) {
      locale = locale || 'ar-JO';
      try {
        var formatter = new Intl.DateTimeFormat(locale, {
          timeZone: timeZone,
          timeZoneName: 'shortGeneric'
        });
        var parts = formatter.formatToParts(new Date());
        var tzPart = parts.find(function(part) { return part.type === 'timeZoneName'; });
        return tzPart ? tzPart.value : timeZone.split('/')[1];
      } catch {
        return timeZone.split('/')[1] || timeZone;
      }
    }

    // Format date for calendar (YYYYMMDDTHHmmssZ)
    function formatCalendarDate(dateStr) {
      var date = new Date(dateStr);
      return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    }

    function composeCalendarEventTitle(params) {
      if (params.eventTypeSlug === 'clinic')
        return 'Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ ÙÙŠ Ø¹ÙŠØ§Ø¯Ø© Ø¯. Ù…Ø¤Ù…Ù† Ø¯ÙŠØ±Ø§Ù†ÙŠØ©';
      else 
        return 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ø¹Ù† Ø¨Ø¹Ø¯ Ù…Ø¹ Ø¯. Ù…Ø¤Ù…Ù† Ø¯ÙŠØ±Ø§Ù†ÙŠØ©';
    }

    // Build description from all query parameters
    function buildCalendarDescription(params) {
      var lines = [];

      var isClinic = params.eventTypeSlug === 'clinic';
      if (isClinic) {
        lines.push(
          `Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù‡Ùˆ ÙÙŠ Ø¹ÙŠØ§Ø¯Ø© Ø¯. Ù…Ø¤Ù…Ù† Ø¯ÙŠØ±Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ù…Ø¬Ù…Ø¹ Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù†ÙˆØ± Ø§Ù„ØªØ®ØµØµÙŠØ© ${
          '' }(Ø¨Ø¬ÙˆØ§Ø± Ø·ÙˆØ§Ø±Ø¦ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ø¨Ù† Ø§Ù„Ù‡ÙŠØ«Ù…). Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· ØºÙˆØºÙ„ Ù‡Ù†Ø§: ${getCalendarLocationLink(params)}`
        );
      } else {
        lines.push(
          `Ù‡Ø°Ù‡ Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…Ø¤Ù…Ù† Ø¯ÙŠØ±Ø§Ù†ÙŠØ© Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ¬ ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©${
          '' } Ø¹Ù† Ø¨Ø¹Ø¯ Ù‡Ùˆ: ${getCalendarLocationLink(params)}`
        );
      }

      lines.push(
        `Ø¥Ù† Ø·Ø±Ø£ Ø·Ø§Ø±Ø¦ ÙˆÙ„Ù… ØªØ³ØªØ·ÙŠØ¹ÙˆØ§ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙ„Ø§ ØªØªØ±Ø¯Ø¯ÙˆØ§ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù†Ø§ https://abuobaydatajjarrah.com/bookings ${
        '\n' } ÙˆØ¥Ù† ÙƒØ§Ù†Øª Ø¹Ù†Ø¯ÙƒÙ… ØªØ³Ø§Ø¤Ù„Ø§Øª Ø£Ùˆ Ø±ØºØ¨ØªÙ… Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„ÙˆØ¬Ø¯ØªÙ… Ù…Ø§ ÙŠÙ„Ø²Ù…ÙƒÙ… Ù„Ø°Ù„Ùƒ Ù‡Ù†Ø§: https://abuobaydatajjarrah.com/#location`
      );

      lines.push(`Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙÙŠ Ù…ÙˆØ¹Ø¯ÙƒÙ… Ù…Ø¹Ù†Ø§ ÙˆÙ†ØªØ·Ù„Ø¹ Ù„Ù„Ù‚Ø§Ø¦ÙƒÙ….`);

      lines.push(new Array(40).fill('-').join(''));

      lines.push(`Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ù‚ØµÙŠØ±Ø© (Øª\u200CÙ„\u200CØ¯\u200CØ±): ${getCalendarLocationLink(params)}`);

      return lines.join('\n\n');
    }

    // Get location based on appointment type
    function getCalendarLocation(params) {
      var isClinic = params.eventTypeSlug === 'clinic';
      if (isClinic) {
        return '31.99769375488415, 35.87301759398745';
      } else {
        return 'Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙˆØµÙ)';
      }
    }

    function getCalendarLocationLink(params) {
      var isClinic = params.eventTypeSlug === 'clinic';
      if (isClinic) {
        return 'https://maps.app.goo.gl/RE3yv34U16Ssdezj7';
      } else {
        return 'https://app.cal.com/video/' + (params.uid || '');
      }
    }

    // Returns a click handler function based on appointment type
    // For clinic appointments: scrolls to location section
    // For remote appointments: opens video link in new tab
    function createLocationLinkHandler(params) {
      var isClinic = params.eventTypeSlug === 'clinic';

      if (isClinic) {
        return function(e) {
          e.preventDefault();
          var locationSection = document.getElementById('location-section');
          if (locationSection) {
            locationSection.scrollIntoView({ behavior: 'smooth' });
          }
        };
      } else {
        var videoUrl = getCalendarLocationLink(params);
        return function(e) {
          e.preventDefault();
          window.open(videoUrl, '_blank', 'noopener,noreferrer');
        };
      }
    }

    // Generate Google Calendar URL
    function generateGoogleCalendarUrl(params) {
      var startDate = formatCalendarDate(params.startTime);
      var endDate = formatCalendarDate(params.endTime);
      var title = composeCalendarEventTitle(params);
      var description = buildCalendarDescription(params);
      var location = getCalendarLocation(params);

      var url = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
      url += '&text=' + encodeURIComponent(title);
      url += '&dates=' + startDate + '/' + endDate;
      url += '&details=' + encodeURIComponent(description);
      url += '&location=' + encodeURIComponent(location);

      return url;
    }

    // Generate Outlook Calendar URL
    function generateOutlookCalendarUrl(params) {
      var startDate = new Date(params.startTime).toISOString();
      var endDate = new Date(params.endTime).toISOString();
      var title = composeCalendarEventTitle(params);
      var description = buildCalendarDescription(params);
      var location = getCalendarLocation(params);

      var url = 'https://outlook.live.com/calendar/0/action/compose?allday=false';
      url += '&subject=' + encodeURIComponent(title);
      url += '&startdt=' + encodeURIComponent(startDate);
      url += '&enddt=' + encodeURIComponent(endDate);
      url += '&body=' + encodeURIComponent(description);
      url += '&location=' + encodeURIComponent(location);

      return url;
    }

    // Generate ICS file content for Apple Calendar
    function generateIcsContent(params) {
      var startDate = formatCalendarDate(params.startTime);
      var endDate = formatCalendarDate(params.endTime);
      var title = composeCalendarEventTitle(params);
      var description = buildCalendarDescription(params).replace(/\n/g, '\\n');
      var location = getCalendarLocation(params);
      var uid = params.uid || Date.now().toString();

      var ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Dr. Mumen Clinic//Booking//AR',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        'UID:' + uid + '@abuobaydatajjarrah.com',
        'DTSTAMP:' + formatCalendarDate(new Date().toISOString()),
        'DTSTART:' + startDate,
        'DTEND:' + endDate,
        'SUMMARY:' + title,
        'DESCRIPTION:' + description,
        'LOCATION:' + location,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');

      return ics;
    }

    // Generate ICS download URL
    function generateIcsDataUrl(params) {
      var icsContent = generateIcsContent(params);
      var blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      return URL.createObjectURL(blob);
    }

    // Setup calendar dropdown toggle
    function setupCalendarDropdown() {
      var btn = document.getElementById('add-to-calendar-btn');
      var dropdown = document.getElementById('calendar-dropdown');

      if (!btn || !dropdown) return;

      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && e.target !== btn) {
          dropdown.classList.add('hidden');
        }
      });

      // Close dropdown when clicking a link
      dropdown.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', function() {
          dropdown.classList.add('hidden');
        });
      });
    }

    // Setup calendar links
    function setupCalendarLinks(params) {
      var container = document.getElementById('add-to-calendar-container');
      var googleLink = document.getElementById('google-calendar-link');
      var appleLink = document.getElementById('apple-calendar-link');
      var outlookLink = document.getElementById('outlook-calendar-link');

      if (!params.startTime || !params.endTime) return;

      // Show the calendar button
      if (container) {
        container.classList.remove('hidden');
      }

      // Set Google Calendar link
      if (googleLink) {
        googleLink.href = generateGoogleCalendarUrl(params);
      }

      // Set Apple Calendar link (ICS file)
      if (appleLink) {
        appleLink.href = generateIcsDataUrl(params);
      }

      // Set Outlook Calendar link
      if (outlookLink) {
        outlookLink.href = generateOutlookCalendarUrl(params);
      }

      setupCalendarDropdown();
    }

    // Update status UI elements
    function updateStatusUI(statusKey) {
      var config = STATUS_CONFIG[statusKey];
      if (!config) return;

      var iconEl = document.getElementById('status-icon');
      var titleEl = document.getElementById('status-title');
      var messageEl = document.getElementById('status-message');

      if (iconEl) iconEl.innerHTML = '<span class="text-6xl">' + config.icon + '</span>';
      if (titleEl) titleEl.textContent = config.title;
      if (messageEl) messageEl.textContent = config.message;
    }

    // Fetch booking status from Cal.com API
    function fetchBookingStatus(bookingUid) {
      return fetch(CAL_API_BASE + '/bookings/' + bookingUid, {
        method: 'GET',
        headers: {
          'cal-api-version': CAL_API_VERSION
        }
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('API request failed: ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        if (data.status === 'success' && data.data) {
          return data.data;
        }
        throw new Error('Invalid API response');
      });
    }

    // Poll for booking status until it changes from pending
    function pollBookingStatus(bookingUid, params, attempt) {
      if (attempt >= MAX_POLL_ATTEMPTS) {
        // Max attempts reached, show error
        updateStatusUI('error');
        return;
      }

      fetchBookingStatus(bookingUid)
        .then(function(booking) {
          var status = booking.status ? booking.status.toLowerCase() : 'pending';

          // Check for final statuses
          if (status === 'accepted') {
            updateStatusUI('accepted');
            showBookingDetails(params, booking);
          } else if (status === 'rejected') {
            updateStatusUI('rejected');
          } else if (status === 'cancelled') {
            updateStatusUI('cancelled');
          } else {
            // Still pending, poll again after interval
            setTimeout(function() {
              pollBookingStatus(bookingUid, params, attempt + 1);
            }, POLL_INTERVAL_MS);
          }
        })
        .catch(function(error) {
          console.error('Error fetching booking status:', error);
          // On error, retry a few times before giving up
          if (attempt < 3) {
            setTimeout(function() {
              pollBookingStatus(bookingUid, params, attempt + 1);
            }, POLL_INTERVAL_MS);
          } else {
            updateStatusUI('error');
          }
        });
    }

    // Show booking details after confirmation
    function showBookingDetails(params, booking) {
      var bookingDetails = document.getElementById('booking-details');
      var locationSection = document.getElementById('location-section');
      var bookingType = document.getElementById('booking-type');
      var bookingDate = document.getElementById('booking-date');
      var bookingTime = document.getElementById('booking-time');

      var isClinic = params.eventTypeSlug === 'clinic';

      // Get attendee timezone from booking data
      var attendeeTimezone = null;
      if (booking && booking.attendees && booking.attendees.length > 0) {
        attendeeTimezone = booking.attendees[0].timeZone;
      }

      // Show booking details
      if (bookingDetails) {
        bookingDetails.classList.remove('hidden');
      }

      // Set booking type
      if (bookingType) {
        bookingType.textContent = isClinic ? 'Ù…ÙˆØ¹Ø¯ ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©' : 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¹Ù† Ø¨Ø¹Ø¯';
      }

      // Set date and time
      if (bookingDate && params.startTime) {
        bookingDate.textContent = 'ÙŠÙˆÙ… ' + formatArabicDate(params.startTime);
      }
      if (bookingTime && params.startTime) {
        var timezoneLabel = attendeeTimezone ? getArabicTimezoneName(attendeeTimezone) : 'ØªÙˆÙ‚ÙŠØªÙƒ';
        bookingTime.textContent = formatArabicTime(params.startTime) + ' Ø¨' + timezoneLabel;
      }

      // Show location for clinic appointments
      if (isClinic && locationSection) {
        locationSection.classList.remove('hidden');
      }

      // Set booking link with JavaScript handler
      var bookingLinkRow = document.getElementById('booking-link-row');
      var bookingLink = document.getElementById('booking-link');
      if (bookingLinkRow && bookingLink) {
        bookingLink.textContent = isClinic ? 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©' : 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© (Ø­ÙŠÙ†Ù…Ø§ ÙŠØ­ÙŠÙ† Ø§Ù„Ù…ÙˆØ¹Ø¯)';
        bookingLink.addEventListener('click', createLocationLinkHandler(params));
        bookingLinkRow.classList.remove('hidden');
      }

      // Setup calendar links
      setupCalendarLinks(params);
    }

    function initBookingComplete() {
      var params = Object.fromEntries(new URLSearchParams(window.location.search));

      // Check if we have booking data
      if (!params.uid) {
        // No UID, cannot verify - show error
        updateStatusUI('error');
        return;
      }

      // Start polling for booking status
      pollBookingStatus(params.uid, params, 0);
    }

    // Initialize on page load
    document.addEventListener('astro:page-load', function() {
      if (window.location.pathname.includes('/landing/booking-complete')) {
        initBookingComplete();
      }
    });
  </script>
</Layout>
