---
import Layout from '~/layouts/PageLayout.astro';
import PhoneVerification from '~/components/booking/PhoneVerification.astro';
import BookingCard from '~/components/booking/BookingCard.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'حجوزاتي',
  robots: {
    index: false,
    follow: false,
  },
};

// API endpoints
const BOOKINGS_ENDPOINT = 'https://n8n.orwa.tech/webhook/4900724b-a648-42f5-91da-7711f0006da1';
---

<Layout metadata={metadata}>
  <section class="py-8 md:py-12">
    <div class="max-w-2xl mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 id="page-title" class="text-2xl md:text-3xl font-bold mb-2 font-heading dark:text-gray-200">
          حجوزاتي
        </h1>
        <p class="text-muted dark:text-slate-400">
          استعرض مواعيدك القادمة
        </p>
        <p class="text-sm text-muted dark:text-slate-500 mt-4 max-w-md mx-auto">
          حجوزاتك مرتبطة برقم هاتفك. للوصول إليها، يجب التحقق من ملكيتك للرقم عبر رسالة نصية قصيرة أو رسالة واتساب. هذا يضمن أن صاحب الرقم فقط هو من يستطيع الاطلاع على مواعيده وإعادة جدولتها وإلغاءها. في الوقت الراهن، لا نوفر طريقة لاستعراض المواعيد السابقة وهذه الصفحة هي لإدارة المواعيد المستقبلية فقط.
        </p>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-muted dark:text-slate-400">جارٍ التحميل...</p>
      </div>

      <!-- Phone Verification (shown when no token or changing phone) -->
      <div id="verification-container" class="hidden">
        <p id="verification-message" class="text-center text-muted dark:text-slate-400 mb-6">
          للاطلاع على حجوزاتك، يرجى التحقق من رقم هاتفك أولاً
        </p>
        <PhoneVerification id="phone-verification" />
        <!-- Cancel button (only shown when changing phone, not for new users) -->
        <div id="cancel-change-container" class="hidden mt-4 text-center">
          <button id="cancel-change-btn" type="button" class="text-sm text-muted dark:text-slate-400 hover:text-primary">
            إلغاء والعودة للحجوزات
          </button>
        </div>
      </div>

      <!-- Bookings List (shown when authenticated) -->
      <div id="bookings-container" class="hidden">
        <!-- Phone display -->
        <div id="phone-display" class="mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <!-- Normal state -->
          <div id="phone-normal-state" class="flex flex-row-reverse flex-wrap-reverse items-center justify-between gap-x-4 gap-y-2">
            <div class="flex flex-row-reverse items-center gap-1 flex-shrink-0">
              <span id="verified-phone" dir="ltr" class="verified-phone-display text-gray-700 dark:text-gray-300 whitespace-nowrap"></span>
              <button id="change-phone-btn" type="button" class="inline-flex items-center gap-1 p-1.5 text-muted hover:text-primary transition-colors" title="تغيير الرقم">
                <Icon name="tabler:arrows-right-left" class="w-3.5 h-3.5" />
                <span class="hidden min-[340px]:inline text-xs">تغيير</span>
              </button>
              <button id="delete-phone-btn" type="button" class="inline-flex items-center gap-1 p-1.5 text-muted hover:text-red-500 transition-colors" title="نسيان الرقم">
                <Icon name="tabler:x" class="w-3.5 h-3.5" />
                <span class="hidden min-[340px]:inline text-xs">نسيان</span>
              </button>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <Icon name="tabler:phone" class="w-5 h-5 text-primary -scale-x-100" />
              <p class="text-secondary whitespace-nowrap">رقم الهاتف المستخدم للحجز</p>
            </div>
          </div>
          <!-- Confirmation state (hidden by default) -->
          <div id="phone-confirm-state" class="hidden flex items-center justify-between">
            <span class="text-sm text-red-600 dark:text-red-400">هل تريد نسيان الرقم <span id="confirm-phone-number" dir="ltr" class="verified-phone-display"></span> من على هذا الجهاز؟</span>
            <div class="flex items-center gap-3">
              <button id="cancel-delete-btn" type="button" class="text-sm text-muted hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                لا
              </button>
              <button id="confirm-delete-btn" type="button" class="text-sm text-red-500 hover:text-red-600 transition-colors">
                نعم
              </button>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="hidden text-center py-6">
          <Icon name="tabler:calendar-off" class="w-12 h-12 mx-auto text-muted mb-3" />
          <p class="text-lg text-muted dark:text-slate-400 mb-4">لا توجد حجوزات قادمة</p>
          <a id="empty-book-btn" href="/book?type=clinic" class="btn-primary inline-flex items-center gap-2">
            <Icon name="tabler:calendar-plus" class="w-5 h-5" />
            <span>احجز موعدًا جديدًا</span>
          </a>
          <!-- Booking type toggle -->
          <div class="flex items-center justify-center gap-3 mt-3">
            <label class="flex items-center gap-3 cursor-pointer text-sm">
              <span id="empty-booking-label" class="text-muted font-bold dark:text-slate-300">موعد في العيادة</span>
              <div class="relative">
                <input
                  type="checkbox"
                  id="empty-booking-type"
                  checked
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 rounded-full peer peer-checked:bg-primary transition-colors"></div>
                <div class="absolute top-0.5 start-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full rtl:peer-checked:-translate-x-full transition-transform"></div>
              </div>
            </label>
          </div>
        </div>

        <!-- Bookings list -->
        <div id="bookings-list" class="space-y-4">
          <!-- BookingCard components will be inserted here dynamically -->
        </div>

        <!-- New booking button (shown when there are bookings) -->
        <div id="new-booking-container" class="hidden mt-8 text-center">
          <a id="new-book-btn" href="/book?type=clinic" class="btn-secondary inline-flex items-center gap-2">
            <Icon name="tabler:calendar-plus" class="w-5 h-5" />
            <span>حجز موعد جديد</span>
          </a>
          <!-- Booking type toggle -->
          <div class="flex items-center justify-center gap-3 mt-4">
            <label class="flex items-center gap-3 cursor-pointer text-sm">
              <span id="new-booking-label" class="text-muted font-bold dark:text-slate-300">موعد في العيادة</span>
              <div class="relative">
                <input
                  type="checkbox"
                  id="new-booking-type"
                  checked
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 rounded-full peer peer-checked:bg-primary transition-colors"></div>
                <div class="absolute top-0.5 start-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full rtl:peer-checked:-translate-x-full transition-transform"></div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center py-12">
        <Icon name="tabler:alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4" />
        <p class="text-xl text-muted dark:text-slate-400 mb-4">حدث خطأ في تحميل الحجوزات</p>
        <button id="retry-btn" type="button" class="btn-primary">
          إعادة المحاولة
        </button>
      </div>

      <!-- Back to Home Link -->
      <div class="text-center mt-8">
        <a href="/" class="text-sm text-muted dark:text-slate-400 hover:text-primary inline-flex items-center gap-1">
          <Icon name="tabler:arrow-right" class="w-4 h-4" />
          <span>العودة للصفحة الرئيسية</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Booking Card Template (hidden, cloned for each booking) -->
  <template id="booking-card-template">
    <BookingCard id="booking-card-template-inner" />
  </template>

  <!-- Phone utilities -->
  <script src="/scripts/phone-utils.js" is:inline></script>
  <!-- Arabic utilities -->
  <script src="/scripts/arabic-utils.js" is:inline></script>

  <style>
    .verified-phone-display {
      font-family: 'New Rail Alphabet', monospace !important;
      letter-spacing: 0.05em;
    }
  </style>

  <script is:inline define:vars={{ BOOKINGS_ENDPOINT }}>
    /* eslint-disable no-var, no-undef */
    var STORAGE_KEY = 'phone_verification_token';
    var BOOKING_TYPE_KEY = 'preferred_booking_type';

    // Booking type toggle management
    function setupBookingTypeToggles() {
      var emptyToggle = document.getElementById('empty-booking-type');
      var emptyLabel = document.getElementById('empty-booking-label');
      var emptyBtn = document.getElementById('empty-book-btn');
      var newToggle = document.getElementById('new-booking-type');
      var newLabel = document.getElementById('new-booking-label');
      var newBtn = document.getElementById('new-book-btn');

      // Load saved preference (default to clinic = checked)
      var savedType = localStorage.getItem(BOOKING_TYPE_KEY);
      var isClinic = savedType !== 'remote'; // Default to clinic

      // Set initial state for both toggles
      function updateToggleState(checked) {
        var type = checked ? 'clinic' : 'remote';
        var label = checked ? 'موعد في العيادة' : 'استشارة عن بعد';
        var href = '/book?type=' + type;

        if (emptyToggle) emptyToggle.checked = checked;
        if (emptyLabel) emptyLabel.textContent = label;
        if (emptyBtn) emptyBtn.href = href;

        if (newToggle) newToggle.checked = checked;
        if (newLabel) newLabel.textContent = label;
        if (newBtn) newBtn.href = href;

        localStorage.setItem(BOOKING_TYPE_KEY, type);
      }

      // Initialize state
      updateToggleState(isClinic);

      // Sync toggles and save preference on change
      if (emptyToggle) {
        emptyToggle.addEventListener('change', function() {
          updateToggleState(this.checked);
        });
      }
      if (newToggle) {
        newToggle.addEventListener('change', function() {
          updateToggleState(this.checked);
        });
      }
    }

    // Set preferred booking type based on most recent booking
    function setPreferredTypeFromBookings(bookings) {
      if (!bookings || bookings.length === 0) return;

      // Sort by start time descending to get most recent
      var sorted = bookings.slice().sort(function(a, b) {
        return new Date(b.start).getTime() - new Date(a.start).getTime();
      });

      var mostRecent = sorted[0];
      var type = mostRecent.eventType?.slug || 'clinic';

      // Only update if no saved preference exists
      if (!localStorage.getItem(BOOKING_TYPE_KEY)) {
        localStorage.setItem(BOOKING_TYPE_KEY, type);
      }
    }

    // UI State management
    function showLoading() {
      document.getElementById('loading-state')?.classList.remove('hidden');
      document.getElementById('verification-container')?.classList.add('hidden');
      document.getElementById('bookings-container')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.add('hidden');
    }

    function showVerification() {
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('verification-container')?.classList.remove('hidden');
      document.getElementById('bookings-container')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.add('hidden');
    }

    function showBookings() {
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('verification-container')?.classList.add('hidden');
      document.getElementById('bookings-container')?.classList.remove('hidden');
      document.getElementById('error-state')?.classList.add('hidden');
    }

    function showError() {
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('verification-container')?.classList.add('hidden');
      document.getElementById('bookings-container')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.remove('hidden');
    }

    // Fetch bookings from API
    // Returns: { status: 'success'|'error', data, networkError: boolean }
    async function fetchBookings(token) {
      try {
        var response = await fetch(BOOKINGS_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ token: token }),
        });
        var data = await response.json();
        data.networkError = false;
        return data;
      } catch {
        return { status: 'error', data: null, networkError: true };
      }
    }

    // Render bookings list
    function renderBookings(bookings, phone) {
      var bookingsList = document.getElementById('bookings-list');
      var emptyState = document.getElementById('empty-state');
      var newBookingContainer = document.getElementById('new-booking-container');
      var phoneDisplay = document.getElementById('verified-phone');
      var template = document.getElementById('booking-card-template');
      var pageTitle = document.getElementById('page-title');

      // Set preferred booking type based on most recent booking (if not already set)
      setPreferredTypeFromBookings(bookings);
      // Setup booking type toggles with the current preference
      setupBookingTypeToggles();

      // Update page title with booking count
      var bookingCount = bookings ? bookings.length : 0;
      if (pageTitle && window.describeNumberOfBookings) {
        pageTitle.textContent = window.describeNumberOfBookings(bookingCount);
      }

      // Display phone number
      if (phoneDisplay && window.formatPhoneDisplay) {
        phoneDisplay.textContent = window.formatPhoneDisplay(phone);
      }

      // Clear existing bookings
      if (bookingsList) {
        bookingsList.innerHTML = '';
      }

      if (!bookings || bookings.length === 0) {
        // Show empty state
        emptyState?.classList.remove('hidden');
        newBookingContainer?.classList.add('hidden');
        return;
      }

      // Sort bookings by start time (earliest first)
      bookings.sort(function(a, b) {
        return new Date(a.start).getTime() - new Date(b.start).getTime();
      });

      // Hide empty state, show new booking button
      emptyState?.classList.add('hidden');
      newBookingContainer?.classList.remove('hidden');

      // Render each booking
      var cardsToInit = [];
      bookings.forEach(function(booking, index) {
        var cardId = 'booking-card-' + index;

        // Clone template
        var templateContent = template?.content;
        if (!templateContent) return;

        var clone = templateContent.cloneNode(true);
        var card = clone.querySelector('[data-booking-card]');

        if (card) {
          card.id = cardId;
          bookingsList?.appendChild(clone);
          cardsToInit.push({ cardId: cardId, booking: booking, index: index + 1 });
        }
      });

      // Initialize cards after all are in the DOM
      // Wait for BookingCardUtils to be available (script may load async)
      var totalBookings = cardsToInit.length;
      function initCards() {
        cardsToInit.forEach(function(item) {
          window.BookingCardUtils.initBookingCard(item.cardId, item.booking, {
            index: item.index,
            total: totalBookings,
            showReschedule: true,
            showCancel: true,
            onLocationClick: function(isClinic, meetingUrl) {
              if (isClinic) {
                window.open('https://maps.app.goo.gl/RE3yv34U16Ssdezj7', '_blank');
              } else {
                window.open(meetingUrl || ('https://app.cal.com/video/' + item.booking.uid), '_blank');
              }
            },
            onReschedule: function(booking) {
              // Open Cal.com modal in reschedule mode
              var calLink = 'د.-مو-من-ديرانية-z6vyi6/' + booking.eventType.slug;
              var config = {
                layout: 'month_view',
                theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
                rescheduleUid: booking.uid
              };
              Cal.ns.bookings("modal", { calLink: calLink, config: config });
            },
            onCancel: function(booking) {
              // Cancel via Cal.com API (no auth needed - UID is sufficient)
              window.BookingCardUtils.cancelBooking(
                item.cardId,
                booking.uid,
                function() {
                  // Success - remove card after delay and update count
                  setTimeout(function() {
                    var card = document.getElementById(item.cardId);
                    if (card) card.remove();
                    updateBookingCount();
                  }, 2000);
                },
                function(message) {
                  console.error('Cancel failed:', message);
                }
              );
            }
          });
        });
      }

      // Use requestAnimationFrame to ensure DOM is updated, then check for utils
      requestAnimationFrame(function() {
        if (window.BookingCardUtils) {
          initCards();
        } else {
          // BookingCardUtils not ready yet, wait for it
          var checkInterval = setInterval(function() {
            if (window.BookingCardUtils) {
              clearInterval(checkInterval);
              initCards();
            }
          }, 50);
          // Timeout after 5 seconds
          setTimeout(function() { clearInterval(checkInterval); }, 5000);
        }
      });
    }

    // Update booking count and card titles after cancellation
    function updateBookingCount() {
      var cards = document.querySelectorAll('[data-booking-card]');
      var count = cards.length;
      var pageTitle = document.getElementById('page-title');

      if (count === 0) {
        // Show empty state
        document.getElementById('bookings-list')?.classList.add('hidden');
        document.getElementById('empty-state')?.classList.remove('hidden');
        document.getElementById('new-booking-container')?.classList.add('hidden');
      }

      if (pageTitle && window.describeNumberOfBookings) {
        pageTitle.textContent = window.describeNumberOfBookings(count);
      }

      // Update remaining card titles with new indices
      if (window.BookingCardUtils) {
        var toArabic = window.BookingCardUtils.toArabicNumerals;
        cards.forEach(function(card, idx) {
          var titleSpan = card.querySelector('.booking-card-title span');
          if (titleSpan) {
            var indexArabic = toArabic(idx + 1);
            var totalArabic = toArabic(count);
            titleSpan.textContent = 'تفاصيل الحجز (' + indexArabic + ' من ' + totalArabic + ')';
          }
        });
      }
    }

    // Main initialization
    async function initBookingsPage() {
      showLoading();

      var token = localStorage.getItem(STORAGE_KEY);

      if (!token) {
        showVerification();
        return;
      }

      // Fetch bookings with token
      var result = await fetchBookings(token);

      if (result.networkError) {
        // Network error - show error state with retry button (keep token)
        showError();
        return;
      }

      if (result.status === 'error' || result.status !== 'success') {
        // Token invalid - clear and show verification
        localStorage.removeItem(STORAGE_KEY);
        showVerification();
        return;
      }

      // Extract phone from token payload returned by endpoint
      var phone = result.token_payload?.phone || '';

      // Cache bookings for returning after phone change cancel
      cachedBookingsData = result.data;
      cachedPhone = phone;

      // Render bookings
      renderBookings(result.data, phone);
      showBookings();
    }

    var cachedBookingsData = null;
    var cachedPhone = '';

    // Show verification form for changing phone (keeps token, shows cancel option)
    function showVerificationForChange() {
      isChangingPhone = true;
      var messageEl = document.getElementById('verification-message');
      var cancelContainer = document.getElementById('cancel-change-container');

      if (messageEl) {
        messageEl.textContent = 'أدخل رقم الهاتف الجديد للتحقق';
      }
      if (cancelContainer) {
        cancelContainer.classList.remove('hidden');
      }
      showVerification();
    }

    // Return to bookings view (used when canceling phone change)
    function returnToBookings() {
      isChangingPhone = false;
      var cancelContainer = document.getElementById('cancel-change-container');
      if (cancelContainer) {
        cancelContainer.classList.add('hidden');
      }

      // Re-render cached bookings if available
      if (cachedBookingsData) {
        renderBookings(cachedBookingsData, cachedPhone);
      }
      showBookings();
    }

    // Event handlers
    function setupEventHandlers() {
      // Phone verified event - saves new token (replaces old one)
      document.addEventListener('phone-verified', function(e) {
        var token = e.detail.token;
        localStorage.setItem(STORAGE_KEY, token);
        isChangingPhone = false;
        // Reload page to fetch bookings with new token
        window.location.reload();
      });

      // Change phone button - shows verification without removing token
      var changePhoneBtn = document.getElementById('change-phone-btn');
      if (changePhoneBtn) {
        changePhoneBtn.addEventListener('click', function() {
          // Don't remove token! Just show verification form with cancel option
          showVerificationForChange();
        });
      }

      // Delete phone button - shows inline confirmation
      var deletePhoneBtn = document.getElementById('delete-phone-btn');
      if (deletePhoneBtn) {
        deletePhoneBtn.addEventListener('click', function() {
          // Copy phone number to confirmation message
          var confirmPhoneEl = document.getElementById('confirm-phone-number');
          if (confirmPhoneEl && cachedPhone && window.formatPhoneDisplay) {
            confirmPhoneEl.textContent = window.formatPhoneDisplay(cachedPhone);
          }
          // Show confirmation state, hide normal state
          document.getElementById('phone-normal-state')?.classList.add('hidden');
          document.getElementById('phone-confirm-state')?.classList.remove('hidden');
        });
      }

      // Confirm delete button - actually removes token
      var confirmDeleteBtn = document.getElementById('confirm-delete-btn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
          localStorage.removeItem(STORAGE_KEY);
          cachedBookingsData = null;
          cachedPhone = '';
          // Reset verification message to default
          var messageEl = document.getElementById('verification-message');
          if (messageEl) {
            messageEl.textContent = 'للاطلاع على حجوزاتك، يرجى التحقق من رقم هاتفك أولاً';
          }
          // Hide cancel button since there's nothing to return to
          var cancelContainer = document.getElementById('cancel-change-container');
          if (cancelContainer) {
            cancelContainer.classList.add('hidden');
          }
          // Reset phone display states
          document.getElementById('phone-normal-state')?.classList.remove('hidden');
          document.getElementById('phone-confirm-state')?.classList.add('hidden');
          showVerification();
        });
      }

      // Cancel delete button - returns to normal state
      var cancelDeleteBtn = document.getElementById('cancel-delete-btn');
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', function() {
          document.getElementById('phone-normal-state')?.classList.remove('hidden');
          document.getElementById('phone-confirm-state')?.classList.add('hidden');
        });
      }

      // Cancel change button - returns to bookings view
      var cancelChangeBtn = document.getElementById('cancel-change-btn');
      if (cancelChangeBtn) {
        cancelChangeBtn.addEventListener('click', function() {
          returnToBookings();
        });
      }

      // Retry button
      var retryBtn = document.getElementById('retry-btn');
      if (retryBtn) {
        retryBtn.addEventListener('click', function() {
          initBookingsPage();
        });
      }
    }

    // Run on initial load
    setupEventHandlers();
    initBookingsPage();

    // Re-run on View Transitions navigation
    document.addEventListener('astro:page-load', function() {
      if (window.location.pathname.startsWith('/bookings')) {
        setupEventHandlers();
        initBookingsPage();
      }
    });
  </script>

  <!-- Cal.com Embed Script (for reschedule modal) -->
  <script is:inline>
    /* eslint-disable prefer-rest-params, no-var, no-undef */
    (function (C, A, L) {
      var p = function (a, ar) { a.q.push(ar); };
      var d = C.document;
      C.Cal = C.Cal || function () {
        var cal = C.Cal;
        var ar = arguments;
        if (!cal.loaded) {
          cal.ns = {};
          cal.q = cal.q || [];
          d.head.appendChild(d.createElement("script")).src = A;
          cal.loaded = true;
        }
        if (ar[0] === L) {
          var api = function () { p(api, arguments); };
          var namespace = ar[1];
          api.q = api.q || [];
          if (typeof namespace === "string") {
            cal.ns[namespace] = cal.ns[namespace] || api;
            p(cal.ns[namespace], ar);
            p(cal, ["initNamespace", namespace]);
          } else p(cal, ar);
          return;
        }
        p(cal, ar);
      };
    })(window, "https://app.cal.com/embed/embed.js", "init");

    Cal("init", "bookings", { origin: "https://app.cal.com" });
    /* eslint-enable prefer-rest-params, no-var */
  </script>
</Layout>