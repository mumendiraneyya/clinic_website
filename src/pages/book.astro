---
import Layout from '~/layouts/PageLayout.astro';
import PhoneVerification from '~/components/booking/PhoneVerification.astro';
import PhoneSelector from '~/components/booking/PhoneSelector.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'حجز موعد',
  robots: {
    index: false,
    follow: false,
  },
};

// API endpoint for token validation
const VALIDATE_TOKEN_ENDPOINT = 'https://n8n.orwa.tech/webhook/b1ac96a5-c166-4ec0-9a3a-37198d210e46';

// Cal.com configuration
const CAL_BASE_LINK = 'د.-مو-من-ديرانية-z6vyi6';
const CAL_NAMESPACE = 'booking';
---

<Layout metadata={metadata}>
  <section class="py-8 md:py-12">
    <div class="max-w-md mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-2xl md:text-3xl font-bold mb-2 font-heading dark:text-gray-200">
          حجز موعد
        </h1>
        <p id="booking-type-label" class="text-muted dark:text-slate-400">
          <!-- Will be set by JS based on type param -->
        </p>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-muted dark:text-slate-400">جارٍ التحقق...</p>
      </div>

      <!-- Phone Selector (shown when valid token exists) -->
      <div id="selector-container" class="hidden">
        <PhoneSelector id="phone-selector" phone="" />
      </div>

      <!-- Phone Verification (shown when no token or changing number) -->
      <div id="verification-container" class="hidden">
        <PhoneVerification id="phone-verification" />
      </div>

      <!-- Back to Home Link -->
      <div class="text-center mt-8">
        <a href="/" class="text-sm text-muted dark:text-slate-400 hover:text-primary inline-flex items-center gap-1">
          <Icon name="tabler:arrow-right" class="w-4 h-4" />
          <span>العودة للصفحة الرئيسية</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Cal.com Embed Script -->
  <script is:inline define:vars={{ CAL_BASE_LINK, CAL_NAMESPACE, VALIDATE_TOKEN_ENDPOINT }}>
    (function (C, A, L) {
      let p = function (a, ar) { a.q.push(ar); };
      let d = C.document;
      C.Cal = C.Cal || function () {
        let cal = C.Cal;
        let ar = arguments;
        if (!cal.loaded) {
          cal.ns = {};
          cal.q = cal.q || [];
          d.head.appendChild(d.createElement("script")).src = A;
          cal.loaded = true;
        }
        if (ar[0] === L) {
          const api = function () { p(api, arguments); };
          const namespace = ar[1];
          api.q = api.q || [];
          if (typeof namespace === "string") {
            cal.ns[namespace] = cal.ns[namespace] || api;
            p(cal.ns[namespace], ar);
            p(cal, ["initNamespace", namespace]);
          } else p(cal, ar);
          return;
        }
        p(cal, ar);
      };
    })(window, "https://app.cal.com/embed/embed.js", "init");

    Cal("init", CAL_NAMESPACE, { origin: "https://app.cal.com" });
  </script>

  <script is:inline define:vars={{ CAL_BASE_LINK, CAL_NAMESPACE, VALIDATE_TOKEN_ENDPOINT }}>
    var STORAGE_KEY = 'phone_verification_token';

    // Get booking type from URL
    function getBookingType() {
      var params = new URLSearchParams(window.location.search);
      return params.get('type') === 'remote' ? 'remote' : 'clinic';
    }

    // Validate token with server
    async function validateToken(token) {
      try {
        var response = await fetch(VALIDATE_TOKEN_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ token: token }),
        });
        return await response.json();
      } catch (e) {
        return { success: false, payload: null };
      }
    }

    // Open Cal.com modal with prefilled data
    function openCalModal(phone, token) {
      var bookingType = getBookingType();
      var calLink = CAL_BASE_LINK + '/' + bookingType;

      var config = {
        layout: 'month_view',
        theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
        attendeePhoneNumber: phone,
        verificationToken: token,
      };

      Cal.ns[CAL_NAMESPACE]("modal", { calLink: calLink, config: config });
    }

    // Show/hide containers
    function showLoading() {
      var el = document.getElementById('loading-state');
      if (el) el.classList.remove('hidden');
      el = document.getElementById('selector-container');
      if (el) el.classList.add('hidden');
      el = document.getElementById('verification-container');
      if (el) el.classList.add('hidden');
    }

    function showSelector(phone) {
      var el = document.getElementById('loading-state');
      if (el) el.classList.add('hidden');
      el = document.getElementById('selector-container');
      if (el) el.classList.remove('hidden');
      el = document.getElementById('verification-container');
      if (el) el.classList.add('hidden');

      // Update phone in selector
      var selector = document.getElementById('phone-selector');
      if (selector) {
        selector.dataset.phone = phone;
        // Update display
        var phoneDisplay = selector.querySelector('p[dir="ltr"]');
        if (phoneDisplay) {
          phoneDisplay.textContent = formatPhoneDisplay(phone);
        }
      }
    }

    function showVerification() {
      var el = document.getElementById('loading-state');
      if (el) el.classList.add('hidden');
      el = document.getElementById('selector-container');
      if (el) el.classList.add('hidden');
      el = document.getElementById('verification-container');
      if (el) el.classList.remove('hidden');
    }

    // Country codes (1-3 digits)
    var countryCodes = [
      '1', '7', '20', '27', '30', '31', '32', '33', '34', '36', '39', '40', '41', '43', '44', '45', '46', '47', '48', '49',
      '51', '52', '53', '54', '55', '56', '57', '58', '60', '61', '62', '63', '64', '65', '66', '81', '82', '84', '86', '90', '91', '92', '93', '94', '95', '98',
      '211', '212', '213', '216', '218', '220', '221', '222', '223', '224', '225', '226', '227', '228', '229', '230', '231', '232', '233', '234', '235', '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '250', '251', '252', '253', '254', '255', '256', '257', '258', '260', '261', '262', '263', '264', '265', '266', '267', '268', '269',
      '290', '291', '297', '298', '299', '350', '351', '352', '353', '354', '355', '356', '357', '358', '359', '370', '371', '372', '373', '374', '375', '376', '377', '378', '380', '381', '382', '383', '385', '386', '387', '389',
      '420', '421', '423', '500', '501', '502', '503', '504', '505', '506', '507', '508', '509', '590', '591', '592', '593', '594', '595', '596', '597', '598', '599',
      '670', '672', '673', '674', '675', '676', '677', '678', '679', '680', '681', '682', '683', '685', '686', '687', '688', '689', '690', '691', '692',
      '850', '852', '853', '855', '856', '880', '886', '960', '961', '962', '963', '964', '965', '966', '967', '968', '970', '971', '972', '973', '974', '975', '976', '977', '992', '993', '994', '995', '996', '998'
    ];

    // Format phone for display
    function formatPhoneDisplay(phone) {
      var digits = phone.replace(/^\+/, '');

      // Find matching country code (check 3-digit, then 2-digit, then 1-digit)
      var countryCode = '';
      for (var len = 3; len >= 1; len--) {
        var prefix = digits.slice(0, len);
        if (countryCodes.indexOf(prefix) !== -1) {
          countryCode = prefix;
          break;
        }
      }

      if (!countryCode) {
        return phone.startsWith('+') ? phone : '+' + phone;
      }

      var rest = digits.slice(countryCode.length);
      // Group remaining digits in chunks of 3
      var groups = rest.match(/.{1,3}/g) || [];
      return '+' + countryCode + ' ' + groups.join(' ');
    }

    // Main initialization
    async function initBookingPage() {
      // Set booking type label
      var bookingType = getBookingType();
      var typeLabel = document.getElementById('booking-type-label');
      if (typeLabel) {
        typeLabel.textContent = bookingType === 'clinic' ? 'موعد في العيادة' : 'استشارة عن بعد';
      }

      var params = new URLSearchParams(window.location.search);
      var changeParam = params.get('change');

      // change=true: skip token check, show verification form
      if (changeParam === 'true') {
        showVerification();
        return;
      }

      showLoading();

      // Check for existing token
      var token = localStorage.getItem(STORAGE_KEY);

      if (token) {
        // Validate token
        var result = await validateToken(token);

        if (result.success && result.payload) {
          // Token is valid, show selector with phone
          var phone = '+' + result.payload.phone;
          showSelector(phone);

          // change=false: auto-open Cal.com (just verified, token confirmed valid)
          if (changeParam === 'false') {
            openCalModal(phone, token);
          }
          return;
        } else {
          // Token invalid, clear it
          localStorage.removeItem(STORAGE_KEY);
        }
      }

      // No valid token, show verification form
      showVerification();
    }

    // Event handlers
    function setupEventHandlers() {
      // Phone verified event (from PhoneVerification component)
      document.addEventListener('phone-verified', function(e) {
        var token = e.detail.token;

        // Save token to localStorage
        localStorage.setItem(STORAGE_KEY, token);

        // Reload page with change=false to sync UI state and auto-open Cal.com
        // This ensures if user cancels Cal.com, they see PhoneSelector not verification form
        var bookingType = getBookingType();
        window.location.href = '/book/?type=' + bookingType + '&change=false';
      });

      // Phone selected event (from PhoneSelector component)
      document.addEventListener('phone-selected', function(e) {
        var phone = e.detail.phone;
        var token = localStorage.getItem(STORAGE_KEY);

        if (token) {
          openCalModal(phone, token);
        }
      });

      // Change phone event (from PhoneSelector component)
      document.addEventListener('change-phone', function() {
        showVerification();
      });
    }

    // Initialize on page load (with guard against double initialization)
    var initialized = false;
    function init() {
      // Only run on this page
      if (!window.location.pathname.startsWith('/book')) return;

      // Prevent double initialization (DOMContentLoaded + astro:page-load can both fire)
      if (initialized) return;
      initialized = true;

      initBookingPage();
      setupEventHandlers();
    }

    // Use DOMContentLoaded as fallback for direct navigation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    document.addEventListener('astro:page-load', init);
  </script>
</Layout>
